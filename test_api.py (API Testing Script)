#!/usr/bin/env python
# ==============================
# ðŸ“„ test_api.py â€” Auralis v5.0
# ==============================

import requests
import sys
import json
import os

BASE_URL = "http://127.0.0.1:8000"


def test_health():
    print("\nðŸ” Testing /health...")
    try:
        r = requests.get(f"{BASE_URL}/health")
        if r.status_code == 200:
            data = r.json()
            print(f"   âœ… Status: {data['status']}")
            print(f"   âœ… Version: {data['version']}")
            print(f"   âœ… Upgraded Mode: {data['upgraded_mode']}")
            return True
        print(f"   âŒ Status Code: {r.status_code}")
        return False
    except requests.exceptions.ConnectionError:
        print("   âŒ Connection failed. Is the server running?")
        return False


def test_labels():
    print("\nðŸ” Testing /labels...")
    try:
        r = requests.get(f"{BASE_URL}/labels")
        if r.status_code == 200:
            data = r.json()
            print(f"   âœ… Locations: {data['num_locations']}")
            print(f"   âœ… Situations: {data['num_situations']}")
            return True
        print(f"   âŒ Status Code: {r.status_code}")
        return False
    except Exception as e:
        print(f"   âŒ Error: {e}")
        return False


def test_analyze(audio_file: str = None):
    print("\nðŸ” Testing /analyze...")
    if not audio_file or not os.path.exists(audio_file):
        print("   âš ï¸ No audio file provided. Skipping.")
        print("   Usage: python test_api.py path/to/audio.wav")
        return True

    print(f"   Using file: {audio_file}")
    try:
        with open(audio_file, 'rb') as f:
            files = {'file': (os.path.basename(audio_file), f, 'audio/wav')}
            r = requests.post(f"{BASE_URL}/analyze", files=files, timeout=120)

        if r.status_code != 200:
            print(f"   âŒ Status: {r.status_code}")
            print(f"   âŒ Body: {r.text[:300]}")
            return False

        d = r.json()

        # Core
        print(f"   âœ… Location:   {d['location']} ({d['location_confidence']*100:.1f}%)")
        print(f"   âœ… Situation:  {d['situation']} ({d['situation_confidence']*100:.1f}%)")
        print(f"   âœ… Emergency:  {d['is_emergency']}")
        print(f"   âœ… Mode:       {d['analysis_mode']}")

        # Emotions
        emo = d.get("emotions", {})
        print(f"   âœ… Emotion:    {emo.get('primary_emotion','?')} (intensity {emo.get('intensity','?')})")
        print(f"      Micro:     {emo.get('micro_emotions', {})}")

        # Speaker confidence
        sc = d.get("speaker_confidence", {})
        print(f"   âœ… Speaker:    {sc.get('score','?')}/10 â€” {sc.get('level','?')}")
        print(f"      Breakdown: {sc.get('breakdown', {})}")

        # Quality
        q = d.get("quality", {})
        print(f"   âœ… Quality:    {q.get('score','?')}/10")
        print(f"      Feedback:  {q.get('feedback', [])}")

        # Semantic
        sem = d.get("semantic_analysis", {})
        print(f"   âœ… Intent:     {sem.get('intent','?')} ({sem.get('intent_confidence','?')})")
        print(f"      Audience:  {sem.get('target_audience','?')}")
        print(f"      Urgency:   {sem.get('urgency_level','?')}")
        print(f"      Topics:    {sem.get('topics', [])}")
        print(f"      Actions:   {sem.get('action_items', [])}")

        # Language
        lang = d.get("language", {})
        print(f"   âœ… Language:   {lang.get('name','?')} ({lang.get('code','?')})")

        # Evidence
        print(f"   âœ… Evidence:   {d.get('evidence', [])}")

        # Timing
        print(f"   âœ… Time:       {d['processing_time_ms']:.0f}ms")

        return True

    except Exception as e:
        print(f"   âŒ Error: {e}")
        return False


def test_feedback():
    print("\nðŸ” Testing /feedback...")
    try:
        data = {
            "request_id": "test123",
            "correct_location": "Airport Terminal",
            "correct_situation": "Boarding/Departure"
        }
        r = requests.post(f"{BASE_URL}/feedback", json=data)
        if r.status_code == 200:
            print(f"   âœ… Status: {r.json()['status']}")
            return True
        print(f"   âŒ Status Code: {r.status_code}")
        return False
    except Exception as e:
        print(f"   âŒ Error: {e}")
        return False


def run_all_tests(audio_file: str = None):
    print("\n" + "="*60)
    print("ðŸ§ª AURALIS v5.0 API TEST SUITE")
    print("="*60)

    results = {
        "health":   test_health(),
        "labels":   test_labels(),
        "analyze":  test_analyze(audio_file),
        "feedback": test_feedback(),
    }

    print("\n" + "="*60)
    print("ðŸ“Š TEST RESULTS")
    print("="*60)
    passed = sum(results.values())
    total  = len(results)
    for test, ok in results.items():
        print(f"   {test}: {'âœ… PASS' if ok else 'âŒ FAIL'}")
    print(f"\n   Total: {passed}/{total} passed")
    print("="*60 + "\n")
    return passed == total


if __name__ == "__main__":
    audio_file = sys.argv[1] if len(sys.argv) > 1 else None
    success = run_all_tests(audio_file)
    sys.exit(0 if success else 1)